<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Championship • Checkpoint Scanner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <style>
    body { margin:0; background:#f3f4f6; }
    #camera {
      width: 100%;
      max-width: 360px;
      margin: 0 auto;
    }
    .result-card {
      margin-top: 16px;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      background: white;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    .result-card img {
      width: 90px; height: 90px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 10px;
      border: 3px solid #2563eb;
    }
    .name {
      font-size: 1.4rem;
      font-weight: 800;
      text-transform: uppercase;
      margin-bottom: 4px;
      word-wrap: break-word;
      white-space: normal;
    }
    .role {
      font-size: 1rem;
      font-weight: bold;
      padding: 4px 10px;
      border-radius: 6px;
      display: inline-block;
      margin: 6px 0;
    }
    .dojo, .id, .time {
      font-size: 1rem;
      font-weight: 600;
      margin-top: 4px;
    }
  </style>
</head>
<body>

  <h1 class="text-lg font-bold text-center p-2">✅ Championship Checkpoint Scanner</h1>

  <!-- Scanner on top -->
  <div id="camera"></div>

  <!-- Result immediately below -->
  <div id="result" class="result-card hidden"></div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDaHqgItxdKb-wQhjRX4mD-4yFyc2sfroE",
    authDomain: "championship-app-4cbd4.firebaseapp.com",
    databaseURL: "https://championship-app-4cbd4-default-rtdb.firebaseio.com",
    projectId: "championship-app-4cbd4",
    storageBucket: "championship-app-4cbd4.appspot.com",
    messagingSenderId: "509794140861",
    appId: "1:509794140861:web:1a3f944428143af9c2add4"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const resultBox = document.getElementById("result");

  function showResult(data, msg) {
    if (!data) return;

    let roleColor = {
      "PLAYER": "bg-blue-600 text-white",
      "JUDGE": "bg-red-600 text-white",
      "COACH": "bg-green-600 text-white",
      "STAFF": "bg-purple-600 text-white",
      "VOLUNTEER": "bg-yellow-600 text-white"
    };

    resultBox.innerHTML = `
      ${data.photo ? `<img src="${data.photo}" alt="Photo"/>` : ""}
      <div class="name">${data.name || 'Unknown'}</div>
      <div class="role ${roleColor[data.role?.toUpperCase()] || 'bg-gray-400 text-white'}">
        ${data.role || ''}
      </div>
      <div class="dojo">Dojo: ${data.dojo || ''}</div>
      <div class="id">ID: ${data.id || ''}</div>
      ${msg ? `<div class="time">${msg}</div>` : ""}
      ${data.attendance?.time ? `<div class="time">Attendance: ${new Date(data.attendance.time).toLocaleTimeString()}</div>` : ""}
    `;
    resultBox.classList.remove("hidden");
  }

  function handleScan(id) {
    const userRef = db.ref("users/" + id);
    userRef.get().then(snap => {
      if (!snap.exists()) {
        resultBox.innerHTML = `<div class="text-red-600 font-bold text-lg">❌ Invalid QR Code</div>`;
        resultBox.classList.remove("hidden");
        return;
      }
      const data = snap.val();
      const now = Date.now();

      if (!data.attendance || !data.attendance.marked) {
        // First time → mark attendance
        userRef.update({ attendance: { marked: true, time: now } });
        data.attendance = { marked: true, time: now };
        showResult(data, "✅ Attendance Marked");
      } else {
        // Already marked → only show details
        showResult(data, "ℹ️ Details Only");
      }
    });
  }

  function onScanSuccess(decodedText) {
    handleScan(decodedText);
  }

  const html5QrCode = new Html5Qrcode("camera");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: 250, height: 250 } },
    onScanSuccess
  ).catch(err => {
    document.getElementById("camera").innerHTML =
      `<p class="text-red-600 text-center">⚠️ Camera access failed: ${err}</p>`;
  });
</script>
</body>
</html>
